# critcatworks
Worklow manager for DFT simulations on nanocluster databases using Fireworks

Beta version features 3 workflows:
1. 
  -automatically generate adsorbates on nanoclusters
  -rank the cluster-adsorbate structures based on similarity
  -run CP2K calculations
  -do machine learning on the fly

2.
  -relax nanocluster structures


3.
  - automatically cover nanoclusters with adsorbates
  - reduce the coverage with a simple heuristic step by step with DFT



Dependencies:
fireworks
cluskit
sklearn

# Quick guide


A few examples are given in the examples folder.
Important to run a workflow:
- Launchpad is connecting to the Fireworks internal MongoDB database. 
- Reset the launchpad only if you have no other workflow running!
- Upload without error. 
- There is a second, permanent MongoDB database. username and password are supplied as arguments to the workflow. If you want to use a database other than the default, specify it in the extdb_connect argument as a dictionary.
- worker_target_path should be an absolute path to the directory where the DFT calculations should be run.
- Once the workflow is added to the launchpad, the jobs can be run through a simple script running in the background of your computing ressource. It can be found in utils. Make sure to adapt the ressources you need in lightweight, medium and dft jobs (They jobs are already precategorized). E.g. machine learning is categorized as medium but its runtime depends on the amount of datapoints. It generates a file called autogenerated_launchpad.yaml which is the yaml representation of the launchpad specified in python.


In order to see whether a job is running, use a classical mechanics cp2k input template first.
e.g. in tests/lj_runs you can find examples which are not heavy. You can also skip the DFT step entirely setting the argument skip_dft = True
You can allocate ressources using salloc and then run a small workflow with 
```sh
rlaunch -l autogenerated_launchpad.yaml rapdifire
```

Query the status of your workflow with the fireworks command line tool. See lpad --help
Query the results in the permanent database through pymongo or the mongo shell. In the future, an API will be provided to facilitate a fast examination of the results. Useful scripts are beeing added to the folder gui.


0. Go to tests/lj_runs

1. Change worker_target_path, username and password in nanoclusters.py

2. python3 nanoclusters.py

3. Change username and password in z_queuelooper.py

4. python3 z_queuelooper.py

5. In another terminal, check the status with 
lpad -l autogenerated_launchpad.yaml get_fws



# Fireworks specs entries 
```python
fw_spec = {
    simulations (dict) : "simulation entries for this workflow",
    workflow (dict) : "relevant information about this workflow",
    machine_learning (dict) : "machine_learning instances of this workflow",
    temp (dict) : 
        {
        calc_paths (list of str) : "paths to the dft calculations, sorted by adsorbate ids",
        calc_ids (list of int) : "ids of simulations in permanent database",
        is_converged_list (list of int) : "1 - converged, 0 - not converged calculation, same order as calc_paths",
        fps_ranking (list of int) : "adsorbate ids ordered by FPS ranking",
        analysis_ids (list of int) : "calculation ids which have been analysed and where analysis can be processed",
        descmatrix (str) : "path to numpy array. 2D-matrix descriptor, row representing datapoint",
        property (list of str) : "property of interest to machine learning",
        last_machine_learning_id (int) : "id of last machine learning step",
        }

    n_calcs_started (int) : "number of calculations which have already been started",
}
    
```

 
# Installation


0. virtual environment recommended
virtualenv --python=python3 critcatenv
source critcatenv/bin/activate

1. Download this repository

2. Go inside this repository
cd critcatworks

3.  slightly modified NOMAD CP2K parser Installation

```sh
pip install numpy cython

cd nomad_parser/python-common
pip install -r requirements.txt
pip install -e .
```

```sh
cd ../parser-cp2k
pip install -e .

4. critcatworks installation

cd ../../

python3 setup.py install
```

5. Deactivate virtual environment

deactivate

--

steps 3 and 4 are automatically executed by 
```sh
./easily_install_all.sh
```

